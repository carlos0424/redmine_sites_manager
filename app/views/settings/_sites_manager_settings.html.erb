<%= stylesheet_link_tag 'sites_manager', plugin: 'redmine_sites_manager' %>
<%= javascript_include_tag 'sites_manager_admin', plugin: 'redmine_sites_manager' %>

<div class="sites-manager-settings">
  <%= form_tag(plugin_settings_path(@plugin), method: :post) do %>
    <div class="box tabular settings">
      <!-- Configuración General -->
      <h3><%= l('plugin_sites_manager.settings.title') %></h3>
      
      <div class="form-field">
        <p>
          <label><%= l('plugin_sites_manager.settings.scope') %></label>
          <%= select_tag 'settings[scope]', 
              options_for_select([
                [l('plugin_sites_manager.settings.global'), 'global'],
                [l('plugin_sites_manager.settings.by_project'), 'project']
              ], @settings['scope']) %>
        </p>
      </div>

      <!-- Mapeo de Campos -->
      <h3><%= l('plugin_sites_manager.settings.custom_fields_mapping') %></h3>
      
      <% custom_fields = CustomField.where(type: 'IssueCustomField').map { |cf| [cf.name, cf.id] } %>
      
      <!-- Campos Principales -->
      <h4><%= l('plugin_sites_manager.settings.main_fields') %></h4>
      <% ['s_id', 'nom_sitio', 'identificador'].each do |field| %>
        <p>
          <label><%= l("plugin_sites_manager.fields.#{field}") %> <span class="required">*</span></label>
          <%= select_tag "settings[custom_fields_mapping][#{field}]", 
              options_for_select(custom_fields, @settings.dig('custom_fields_mapping', field)),
              include_blank: true %>
        </p>
      <% end %>

      <!-- Campos de Ubicación -->
      <h4><%= l('plugin_sites_manager.settings.location_fields') %></h4>
      <% ['depto', 'municipio', 'direccion'].each do |field| %>
        <p>
          <label><%= l("plugin_sites_manager.fields.#{field}") %></label>
          <%= select_tag "settings[custom_fields_mapping][#{field}]", 
              options_for_select(custom_fields, @settings.dig('custom_fields_mapping', field)),
              include_blank: true %>
        </p>
      <% end %>

      <!-- Campos de Características -->
      <h4><%= l('plugin_sites_manager.settings.characteristic_fields') %></h4>
      <% ['jerarquia_definitiva', 'fijo_variable', 'coordinador'].each do |field| %>
        <p>
          <label><%= l("plugin_sites_manager.fields.#{field}") %></label>
          <%= select_tag "settings[custom_fields_mapping][#{field}]", 
              options_for_select(custom_fields, @settings.dig('custom_fields_mapping', field)),
              include_blank: true %>
        </p>
      <% end %>

      <!-- Campos Adicionales -->
      <h4><%= l('plugin_sites_manager.settings.additional_fields') %></h4>
      <% (1..5).each do |i| %>
        <p>
          <label><%= l("plugin_sites_manager.fields.campo_adicional_#{i}") %></label>
          <%= select_tag "settings[custom_fields_mapping][campo_adicional_#{i}]", 
              options_for_select(custom_fields, @settings.dig('custom_fields_mapping', "campo_adicional_#{i}")),
              include_blank: true %>
        </p>
      <% end %>

      <!-- Botones de acción -->
      <div class="form-actions">
        <%= submit_tag l(:button_save), class: 'button-positive' %>
        <%= link_to l(:button_cancel), 
            { controller: 'settings', action: 'plugin', id: 'redmine_sites_manager' }, 
            class: 'button' %>
      </div>
    </div>
  <% end %>
</div>

<% content_for :header_tags do %>
  <style>
    .sites-manager-settings {
      margin: 20px 0;
    }
    .sites-manager-settings h3 {
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #ccc;
    }
    .sites-manager-settings h4 {
      margin: 20px 0 10px 0;
      color: #666;
    }
    .sites-manager-settings p {
      margin-bottom: 10px;
      padding: 5px 0;
    }
    .sites-manager-settings label {
      display: block;
      margin-bottom: 3px;
      font-weight: bold;
    }
    .sites-manager-settings select {
      width: 100%;
      max-width: 400px;
      padding: 4px;
    }
    .required {
      color: #d00;
    }
    .form-actions {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ccc;
      text-align: right;
    }
    .button-positive {
      margin-left: 10px;
    }
  </style>
<% end %>